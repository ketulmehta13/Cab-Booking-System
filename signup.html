<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js">
    </script>

    <style>
        body {
            font-family: sans-serif;
            background-image: url(img/bg.jpg);
            color: white;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .signup-container {
            background: #444;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
            position: relative;
        }

        .signup-container h2 {
            text-align: center;
            color: yellow;
            margin-bottom: 20px;
        }

        .form-group label {
            font-weight: bold;
        }

        .form-control {
            background: #555;
            border: none;
            color: white;
        }

        .btn-yellow {
            background-color: yellow;
            border: none;
            color: black;
            font-size: 18px;
            font-weight: bold;
            padding: 10px;
            width: 100%;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 22px;
            cursor: pointer;
            color: yellow;
        }
    </style>
</head>

<body>
    <div class="modal-container" id="signupModal">
        <div class="signup-container">
            <span class="close" id="closeModal">&times;</span>
            <h2>Create your account</h2>
            <form id="signupForm">
                <div class="form-group">
                    <label for="name">Username:</label>
                    <input type="text" id="name" class="form-control" placeholder="Enter your username" required>
                    <small id="nameError" class="text-danger"></small>
                </div>
                <div class="form-group">
                    <label for="email">Email address:</label>
                    <input type="email" id="email" class="form-control" placeholder="Enter your email" required>
                    <small id="emailError" class="text-danger"></small>
                </div>
                <div class="form-group">
                    <label for="password">Password:</label>
                    <input type="password" id="password" class="form-control" placeholder="Create a password" required>
                    <small id="passwordError" class="text-danger"></small>
                </div>
                <button type="submit" id="submitBtn" class="btn btn-yellow">Sign Up</button>
                <p class="text-center mt-3">
                    <a href="login.html" style="color: yellow;">Already have an account? Login</a>
                </p>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
        import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBu1aXuJGGob1WNf9ONGHXtyPDB-ABo5lI",
            authDomain: "contactform-b6bd2.firebaseapp.com",
            databaseURL: "https://contactform-b6bd2-default-rtdb.firebaseio.com",
            projectId: "contactform-b6bd2",
            storageBucket: "contactform-b6bd2.appspot.com",
            messagingSenderId: "289204893801",
            appId: "1:289204893801:web:88c4e9a0d15239ff348af8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        document.getElementById("signupForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const name = document.getElementById("name").value.trim();
            const email = document.getElementById("email").value.trim();
            const password = document.getElementById("password").value.trim();
            const sanitizedEmail = email.replace(/\./g, '_');

            const namePattern = /^[A-Za-z0-9_]{3,}$/;
            const emailPattern = /^\w+([\.-]?\w+)*@\w+([\.-]?\w+)*(\.\w{2,3})+$/;
            const passwordPattern = /^.{6,}$/;

            let valid = true;

            if (!namePattern.test(name)) {
                document.getElementById("nameError").innerText = "Username must be at least 3 characters long and contain only letters, numbers, or underscores.";
                valid = false;
            } else {
                document.getElementById("nameError").innerText = "";
            }

            if (!emailPattern.test(email)) {
                document.getElementById("emailError").innerText = "Invalid email format.";
                valid = false;
            } else {
                document.getElementById("emailError").innerText = "";
            }

            if (!passwordPattern.test(password)) {
                document.getElementById("passwordError").innerText = "Password must be at least 6 characters long.";
                valid = false;
            } else {
                document.getElementById("passwordError").innerText = "";
            }

            if (!valid) return;

            const dbRef = ref(db);

            get(child(dbRef, `users/${sanitizedEmail}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    document.getElementById("emailError").innerText = "Email already exists. Please use a different email.";
                } else {
                    get(child(dbRef, 'users')).then((userSnapshot) => {
                        let usernameExists = false;
                        userSnapshot.forEach((childSnapshot) => {
                            if (childSnapshot.val().fullName === name) {
                                usernameExists = true;
                            }
                        });

                        if (usernameExists) {
                            document.getElementById("nameError").innerText = "Username already taken. Please choose another.";
                        } else {
                            set(ref(db, 'users/' + sanitizedEmail), {
                                fullName: name,
                                email: email,
                                password: password,
                            }).then(() => {
                                alert("Signup successful!");
                                sendEmailNotification(name, email);
                                localStorage.setItem("loggedIn", "true");
                                localStorage.setItem("userEmail", email);
                            }).catch((error) => {
                                alert("Error signing up: " + error.message);
                            });
                        }
                    });
                }
            });
        });


        document.getElementById("closeModal").addEventListener("click", function () {
            window.location.href = "index.html";
        });

    </script>

<script>
    (function () {
        emailjs.init("3n-LwvskctBUqrrNz");
    })();

    function sendEmailNotification(name, email) {
        const templateParams = {
            user_name: name,
            from_name: "Ridex (Cab Booking System)",
            user_email: email,
            message: "Thank you for signing up! Welcome to our platform."
        };

        emailjs.send("service_0lkd1u7", "template_fl1dumn", templateParams)
            .then(function (response) {
                console.log("Email sent successfully!", response.status, response.text);
                window.location.href = "index.html"; // Redirect to home after email is sent
            }, function (error) {
                console.log("Failed to send email", error);
                alert("Signup successful, but email could not be sent.");
                window.location.href = "index.html"; // Redirect even if email fails
            });
    }
</script>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>